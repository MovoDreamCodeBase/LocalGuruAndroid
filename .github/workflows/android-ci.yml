name: Android CI

on:
  push:
    branches:
      - dev        # üîπ QC / learning / internal builds
      - main       # üîπ Production builds

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # 1Ô∏è Checkout source code
      # -----------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------
      # 2Ô∏è Setup Java (required for Gradle)
      # -----------------------------
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # -----------------------------
      # 3Ô∏è Gradle permission
      # -----------------------------
      - name: Grant permission to Gradle
        run: chmod +x gradlew

      # ============================================================
      #  DEV BRANCH (QC / Learning)
      # ============================================================

      # -----------------------------
      # 4Ô∏è Read versionName from Gradle
      # -----------------------------
      - name: Extract versionName
        if: github.ref == 'refs/heads/dev'
        run: |
          VERSION_NAME=$(./gradlew -q printVersionName)
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV

      # -----------------------------
      # 5Ô∏è Build metadata for artifact naming
      # -----------------------------
      - name: Set build metadata
        if: github.ref == 'refs/heads/dev'
        run: |
          echo "BUILD_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
          echo "SHORT_SHA=${GITHUB_SHA::7}" >> $GITHUB_ENV

      # -----------------------------
      # 6Ô∏è Decode DEBUG keystore (QC builds)
      # -----------------------------
      - name: Decode CI debug keystore
        if: github.ref == 'refs/heads/dev'
        run: |
          echo "${{ secrets.CI_DEBUG_KEYSTORE }}" | base64 --decode > app/ci-debug.keystore

      # -----------------------------
      # 7Ô∏è Decode RELEASE keystore (DEV learning)
      # -----------------------------
      - name: Decode release keystore (DEV)
        if: github.ref == 'refs/heads/dev'
        run: |
          echo "${{ secrets.RELEASE_KEYSTORE }}" | base64 --decode > app/release.keystore

      # -----------------------------
      # 8Ô∏è Build DEV Debug APK (QC)
      # -----------------------------
      - name: Build Debug APK (QC)
        if: github.ref == 'refs/heads/dev'
        run: ./gradlew assembleDevDebug

      # -----------------------------
      # 9Ô∏è Upload DEV Debug APK
      # -----------------------------
      - name: Upload Debug APK (QC)
        if: github.ref == 'refs/heads/dev'
        uses: actions/upload-artifact@v4
        with:
          name: qc-debug-apk_v${{ env.VERSION_NAME }}_${{ env.BUILD_DATE }}_${{ github.run_number }}_${{ env.SHORT_SHA }}
          path: app/build/outputs/apk/dev/debug/app-dev-debug.apk

      # -----------------------------
      # 10 Build SIGNED DEV Release APK (Learning)
      # -----------------------------
      - name: Build Signed Release APK (DEV)
        if: github.ref == 'refs/heads/dev'
        run: ./gradlew assembleDevRelease

      # -----------------------------
      # 1Ô∏è1Ô∏è Build SIGNED DEV Release AAB (Learning)
      # -----------------------------
      - name: Build Signed Release AAB (DEV)
        if: github.ref == 'refs/heads/dev'
        run: ./gradlew bundleDevRelease

      # -----------------------------
      # 1Ô∏è2 Upload SIGNED DEV Release APK
      # -----------------------------
      - name: Upload Signed Release APK (DEV)
        if: github.ref == 'refs/heads/dev'
        uses: actions/upload-artifact@v4
        with:
          name: dev-release-apk
          path: app/build/outputs/apk/dev/release/app-dev-release.apk

      # -----------------------------
      # 1Ô∏è3Ô∏è Upload SIGNED DEV Release AAB
      # -----------------------------
      - name: Upload Signed Release AAB (DEV)
        if: github.ref == 'refs/heads/dev'
        uses: actions/upload-artifact@v4
        with:
          name: dev-release-aab
          path: app/build/outputs/bundle/devRelease/app-dev-release.aab

      # ============================================================
      # üîπ MAIN BRANCH (PRODUCTION)
      # ============================================================

      # -----------------------------
      # 1Ô∏è4Ô∏è Decode RELEASE keystore (Production)
      # -----------------------------
      - name: Decode release keystore (PROD)
        if: github.ref == 'refs/heads/main'
        run: |
          echo "${{ secrets.RELEASE_KEYSTORE }}" | base64 --decode > app/release.keystore

      # -----------------------------
      # 1Ô∏è5Ô∏è Build SIGNED PROD Release AAB (Play Store)
      # -----------------------------
      - name: Build Release AAB (Production)
        if: github.ref == 'refs/heads/main'
        run: ./gradlew bundleProdRelease
