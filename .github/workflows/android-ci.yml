name: Android CI

on:
  push:
    branches:
      - dev        # üîπ QC / learning / internal builds
      - main       # üîπ Production builds

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # 1Ô∏è‚É£ Checkout source code
      # -----------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------
      # 2Ô∏è‚É£ Setup Java (required for Gradle)
      # -----------------------------
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # -----------------------------
      # 3Ô∏è‚É£ Grant Gradle permission
      # -----------------------------
      - name: Grant permission to Gradle
        run: chmod +x gradlew

      # ============================================================
      # üîπ DEV BRANCH (QC / Learning)
      # ============================================================

      # -----------------------------
      # 4Ô∏è‚É£ Extract versionName
      # -----------------------------
      - name: Extract versionName
        if: github.ref == 'refs/heads/dev'
        run: |
          VERSION_NAME=$(./gradlew -q printVersionName)
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV

      # -----------------------------
      # 5Ô∏è‚É£ Set build metadata
      # -----------------------------
      - name: Set build metadata
        if: github.ref == 'refs/heads/dev'
        run: |
          echo "BUILD_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
          echo "SHORT_SHA=${GITHUB_SHA::7}" >> $GITHUB_ENV

      # -----------------------------
      # 6Ô∏è‚É£ Decode DEBUG keystore (QC)
      # -----------------------------
      - name: Decode CI debug keystore
        if: github.ref == 'refs/heads/dev'
        run: |
          echo "${{ secrets.CI_DEBUG_KEYSTORE }}" | base64 --decode > app/ci-debug.keystore

      # ----------------------------------------------------------------
      #  DEBUG APK BUILD & UPLOAD (COMMENTED ‚Äì ENABLE WHEN NEEDED)
      # ----------------------------------------------------------------
      #
      # - name: Build Debug APK (QC)
      #   if: github.ref == 'refs/heads/dev'
      #   run: ./gradlew assembleDevDebug
      #
      # - name: Upload Debug APK (QC)
      #   if: github.ref == 'refs/heads/dev'
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: qc-debug-apk_v${{ env.VERSION_NAME }}_${{ env.BUILD_DATE }}_${{ github.run_number }}_${{ env.SHORT_SHA }}
      #     path: app/build/outputs/apk/dev/debug/app-dev-debug.apk
      #
      # ----------------------------------------------------------------

      # -----------------------------
      # 7Ô∏è‚É£ Decode RELEASE keystore (DEV learning)
      # -----------------------------
      - name: Decode release keystore (DEV)
        if: github.ref == 'refs/heads/dev'
        run: |
          echo "${{ secrets.RELEASE_KEYSTORE }}" | base64 --decode > app/release.keystore

      # -----------------------------
      # 8Ô∏è‚É£ Build SIGNED DEV Release APK
      # -----------------------------
      - name: Build Signed Release APK (DEV)
        if: github.ref == 'refs/heads/dev'
        env:
          RELEASE_STORE_PASSWORD: ${{ secrets.RELEASE_STORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
        run: ./gradlew assembleDevRelease

      # -----------------------------
      # 9Ô∏è‚É£ Build SIGNED DEV Release AAB
      # -----------------------------
      - name: Build Signed Release AAB (DEV)
        if: github.ref == 'refs/heads/dev'
        env:
          RELEASE_STORE_PASSWORD: ${{ secrets.RELEASE_STORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
        run: ./gradlew bundleDevRelease

      # -----------------------------
      # üîü Upload SIGNED DEV Release APK
      # -----------------------------
      - name: Upload Signed Release APK (DEV)
        if: github.ref == 'refs/heads/dev'
        uses: actions/upload-artifact@v4
        with:
          name: dev-release-apk
          path: app/build/outputs/apk/dev/release/app-dev-release.apk

      # -----------------------------
      # 1Ô∏è‚É£1Ô∏è‚É£ Upload SIGNED DEV Release AAB
      # -----------------------------
      - name: Upload Signed Release AAB (DEV)
        if: github.ref == 'refs/heads/dev'
        uses: actions/upload-artifact@v4
        with:
          name: dev-release-aab
          path: app/build/outputs/bundle/devRelease/app-dev-release.aab

      # ============================================================
      # üîπ MAIN BRANCH (PRODUCTION)
      # ============================================================

      # -----------------------------
      # 1Ô∏è‚É£2Ô∏è‚É£ Decode RELEASE keystore (PROD)
      # -----------------------------
      - name: Decode release keystore (PROD)
        if: github.ref == 'refs/heads/main'
        run: |
          echo "${{ secrets.RELEASE_KEYSTORE }}" | base64 --decode > app/release.keystore

      # -----------------------------
      # 1Ô∏è‚É£3Ô∏è‚É£ Build SIGNED PROD Release AAB (NO UPLOAD)
      # -----------------------------
      - name: Build Release AAB (Production)
        if: github.ref == 'refs/heads/main'
        env:
          RELEASE_STORE_PASSWORD: ${{ secrets.RELEASE_STORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
        run: ./gradlew bundleProdRelease
