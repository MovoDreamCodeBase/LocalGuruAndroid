name: Android CI

on:
  push:
    branches:
      - dev        # ðŸ”¹ QC / learning / internal builds
      - main       # ðŸ”¹ Production builds

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # 1ï¸âƒ£ Checkout source code
      # -----------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------
      # 2ï¸âƒ£ Setup Java (required for Gradle)
      # -----------------------------
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # -----------------------------
      # 3ï¸âƒ£ Grant Gradle permission
      # -----------------------------
      - name: Grant permission to Gradle
        run: chmod +x gradlew

      # ============================================================
      # ðŸ”¹ DEV BRANCH (QC / Learning)
      # ============================================================

      # -----------------------------
      # 4ï¸âƒ£ Extract versionName
      # -----------------------------
      - name: Extract versionName
        if: github.ref == 'refs/heads/dev'
        run: |
          VERSION_NAME=$(./gradlew -q printVersionName)
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV

      # -----------------------------
      # 5ï¸âƒ£ Set build metadata
      # -----------------------------
      - name: Set build metadata
        if: github.ref == 'refs/heads/dev'
        run: |
          echo "BUILD_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
          echo "SHORT_SHA=${GITHUB_SHA::7}" >> $GITHUB_ENV

      # -----------------------------
      # 6ï¸âƒ£ Decode DEBUG keystore (QC)
      # -----------------------------
      - name: Decode CI debug keystore
        if: github.ref == 'refs/heads/dev'
        run: |
          echo "${{ secrets.CI_DEBUG_KEYSTORE }}" | base64 --decode > app/ci-debug.keystore

      # ----------------------------------------------------------------
      #  DEBUG APK BUILD & UPLOAD (COMMENTED â€“ ENABLE WHEN NEEDED)
      # ----------------------------------------------------------------
      #
      # - name: Build Debug APK (QC)
      #   if: github.ref == 'refs/heads/dev'
      #   run: ./gradlew assembleDevDebug
      #
      # - name: Upload Debug APK (QC)
      #   if: github.ref == 'refs/heads/dev'
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: qc-debug-apk_v${{ env.VERSION_NAME }}_${{ env.BUILD_DATE }}_${{ github.run_number }}_${{ env.SHORT_SHA }}
      #     path: app/build/outputs/apk/dev/debug/app-dev-debug.apk
      #
      # ----------------------------------------------------------------

      # -----------------------------
      # 7ï¸âƒ£ Decode RELEASE keystore (DEV learning)
      # -----------------------------
      - name: Decode release keystore (DEV)
        if: github.ref == 'refs/heads/dev'
        run: |
          echo "${{ secrets.RELEASE_KEYSTORE }}" | base64 --decode > app/release.keystore

      # -----------------------------
      # 8ï¸âƒ£ Build SIGNED DEV Release APK
      # -----------------------------
      - name: Build Signed Release APK (DEV)
        if: github.ref == 'refs/heads/dev'
        env:
          RELEASE_STORE_PASSWORD: ${{ secrets.RELEASE_STORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
        run: ./gradlew assembleDevRelease

#      # -----------------------------
#      # 9ï¸âƒ£ Build SIGNED DEV Release AAB
#      # -----------------------------
#      - name: Build Signed Release AAB (DEV)
#        if: github.ref == 'refs/heads/dev'
#        env:
#          RELEASE_STORE_PASSWORD: ${{ secrets.RELEASE_STORE_PASSWORD }}
#          RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
#          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
#        run: ./gradlew bundleDevRelease
#
#      # -----------------------------
#      # ðŸ”Ÿ Upload SIGNED DEV Release APK (GitHub Artifact)
#      # -----------------------------
#      - name: Upload Signed Release APK (DEV)
#        if: github.ref == 'refs/heads/dev'
#        uses: actions/upload-artifact@v4
#        with:
#          name: dev-release-apk
#          path: app/build/outputs/apk/dev/release/app-dev-release.apk
#
#      # -----------------------------
#      # 1ï¸âƒ£1ï¸âƒ£ Upload SIGNED DEV Release AAB (GitHub Artifact)
#      # -----------------------------
#      - name: Upload Signed Release AAB (DEV)
#        if: github.ref == 'refs/heads/dev'
#        uses: actions/upload-artifact@v4
#        with:
#          name: dev-release-aab
#          path: app/build/outputs/bundle/devRelease/app-dev-release.aab

      # ============================================================
      # ðŸ”¥ FIREBASE APP DISTRIBUTION (DEV ONLY)
      # ============================================================

      # Install Firebase CLI
      - name: Install Firebase CLI
        if: github.ref == 'refs/heads/dev'
        run: npm install -g firebase-tools

      # Decode Firebase service account
      - name: Decode Firebase service account
        if: github.ref == 'refs/heads/dev'
        run: |
          echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" | base64 --decode > firebase-service-account.json

      # Upload APK to Firebase App Distribution (INSTALL LINK GENERATED)
      - name: Upload APK to Firebase App Distribution
        if: github.ref == 'refs/heads/dev'
        env:
          GOOGLE_APPLICATION_CREDENTIALS: firebase-service-account.json
        run: |
          firebase appdistribution:distribute \
            app/build/outputs/apk/dev/release/app-dev-release.apk \
            --app 1:996486041848:android:ce744cf515fcce18e3ab0d \
            --groups "qa,internal" \
            --release-notes "CI build #${{ github.run_number }} - ${{ github.sha }}"

      # ============================================================
      # ðŸ”¹ MAIN BRANCH (PRODUCTION)
      # ============================================================

      # Decode RELEASE keystore
#      - name: Decode release keystore (PROD)
#        if: github.ref == 'refs/heads/main'
#        run: |
#          echo "${{ secrets.RELEASE_KEYSTORE }}" | base64 --decode > app/release.keystore
#
#      # Build SIGNED PROD Release APK
#      - name: Build Signed Production APK
#        if: github.ref == 'refs/heads/main'
#        env:
#          RELEASE_STORE_PASSWORD: ${{ secrets.RELEASE_STORE_PASSWORD }}
#          RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
#          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
#        run: ./gradlew assembleProdRelease
#
#      # Build SIGNED PROD Release AAB
#      - name: Build Release AAB (Production)
#        if: github.ref == 'refs/heads/main'
#        env:
#          RELEASE_STORE_PASSWORD: ${{ secrets.RELEASE_STORE_PASSWORD }}
#          RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
#          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
#        run: ./gradlew bundleProdRelease
#
#      # Upload SIGNED PROD Release APK
#      - name: Upload Release APK (Production)
#        if: github.ref == 'refs/heads/main'
#        uses: actions/upload-artifact@v4
#        with:
#          name: prod-release-apk
#          path: app/build/outputs/apk/prod/release/app-prod-release.apk
#
#      # Upload SIGNED PROD Release AAB
#      - name: Upload Release AAB (Production)
#        if: github.ref == 'refs/heads/main'
#        uses: actions/upload-artifact@v4
#        with:
#          name: prod-release-aab
#          path: app/build/outputs/bundle/prodRelease/app-prod-release.aab
